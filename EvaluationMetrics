import numpy as np
import utils
import pandas as pd
import matplotlib.pyplot as plt


def MRR(ground_truth_dict, search_engine_conf):
    """

    :param ground_truth_dict:
    :param search_engine_conf:
    :return:
    """
    MRR_results = []
    for key, value in search_engine_conf.items():
        first_relevant_index_list = []
        for query_id, doc_ids in value.items():
            try:
                first_relevant_index = doc_ids.index(
                    next((i for i in ground_truth_dict[str(query_id)] if i in doc_ids), None)) + 1
                first_relevant_index_list.append(first_relevant_index)
            except:
                continue
        MRR_results.append((1 / len(ground_truth_dict)) * np.sum(1 / np.array(first_relevant_index_list)))

    return MRR_results


def R_Precision(ground_truth_dict, search_engine_conf):

    r_precision_list = []
    for key, value in search_engine_conf.items():
        res_temp = []
        for query_id, doc_ids in ground_truth_dict.items():
            res = len(set(ground_truth_dict[query_id]).intersection(set(value[int(query_id)][:len(ground_truth_dict[query_id])]))) / len(ground_truth_dict[query_id])
            res_temp.append(res)
        r_precision_list.append(res_temp)

    return r_precision_list


def P_at_k(ground_truth_dict, search_engine_conf, top_k=[1, 3, 5, 10]):
    """

    :param ground_truth_dict:
    :param search_engine_conf: Should only contain the top 5 already
    :param top_k:
    :return:
    """
    top_k_list = dict()
    for k in top_k:
        p_at_k_list = []
        for key, value in search_engine_conf.items():
            res_temp = []
            for query_id, doc_ids in ground_truth_dict.items():
                res = len(set(ground_truth_dict[query_id]).intersection(
                    set(value[int(query_id)][:k]))) / min(k, len(ground_truth_dict[query_id]))
                res_temp.append(res)
            p_at_k_list.append(res_temp)
        top_k_list[k] = list(np.mean(p_at_k_list, axis=1))

    return top_k_list


def main():
    ground_truth_path = './data/cran_Ground_Truth.tsv'
    search_engine_conf_path = './data/total_query_results.json'
    configuration_path = './data/SearchEngines.csv'

    ground_truth_dict = utils.read_ground_truth(ground_truth_path)
    search_engine_conf = utils.read_json(search_engine_conf_path)
    MRR_results = MRR(ground_truth_dict, search_engine_conf)
    R_precision_results = R_Precision(ground_truth_dict, search_engine_conf)

    configurations = pd.read_csv(configuration_path)
    configurations['MRR'] = MRR_results
    configurations['Mean'] = np.mean(R_precision_results, axis=1)
    configurations['Min'] = np.min(R_precision_results, axis=1)
    configurations['Max'] = np.max(R_precision_results, axis=1)
    configurations['Median'] = np.median(R_precision_results, axis=1)
    configurations['1_quartile'] = np.quantile(a=R_precision_results, q=.25, axis=1)
    configurations['3_quartile'] = np.quantile(a=R_precision_results, q=.75, axis=1)

    configurations_top_5 = configurations.sort_values(by=['MRR']).head(5).SE_ID
    print(list(configurations_top_5))
    search_engine_conf_top_5 = {key: search_engine_conf[key] for key in configurations_top_5}
    P_at_k_res = P_at_k(ground_truth_dict, search_engine_conf_top_5)
    print(P_at_k_res)
    print(pd.DataFrame(P_at_k_res))
    temp_df = pd.DataFrame(P_at_k_res).transpose()
    print(temp_df)
    temp_df.plot()
    plt.show()


    configurations.to_csv(r'./data/SearchEnginesTest.csv', index=False)


if __name__ == "__main__":
    main()





